\usepackage{float}
\usepackage[group-separator={,}]{siunitx}
\usepackage{graphicx}
\usepackage{subfig}
\usepackage[svgnames]{xcolor} 
\usepackage{fancyhdr}
\usepackage[subfigure]{tocloft}
\usepackage[hidelinks]{hyperref}
\usepackage{enumitem}
\usepackage[many]{tcolorbox}
\usepackage{listings }
\usepackage[a4paper, total={6in, 8in}, top = 4cm, bottom = 4cm]{geometry}
\usepackage{afterpage}
\usepackage{amssymb}
\usepackage{pdflscape}
\usepackage{textcomp}
\usepackage{xecolor}
\usepackage{rotating}
\usepackage[localise=on,extrafootnotefeatures]{xepersian}
\usepackage[T1]{fontenc}
\usepackage{tikz}
\usepackage[utf8]{inputenc}
\usepackage{PTSerif} 
\usepackage{seqsplit}
\usepackage{changepage}
\usepackage{csvsimple}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{sectsty}
\usepackage{pgf-pie}
\usepackage{pgfplots}
\setcounter{secnumdepth}{0}
 
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}
\definecolor{blanchedalmond}{rgb}{1.0, 0.92, 0.8}
\definecolor{brilliantlavender}{rgb}{0.96, 0.73, 1.0}
\newcommand{\nop}[1]{}
\NewDocumentCommand{\codeword}{v}{
\lr{\texttt{\textcolor{blue}{#1}}}
}
\lstset{language=c,keywordstyle={\bfseries \color{blue}}}

\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{codegreen},
    keywordstyle=\color{magenta},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{codepurple},
    basicstyle=\ttfamily\normalsize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2
}

\lstset{style=mystyle}

\settextfont[Path=fonts/,BoldFont={XB Zar bold.ttf},ItalicFont={XB Zar italic.ttf}]{XB Zar.ttf}

\newcommand{\link}[2]{\href{#1}{\textcolor{blue}{#2}}}

\setlatintextfont[Path=fonts/,Scale=1.0,
 BoldFont={LiberationSerif-Bold.ttf}, 
 ItalicFont={LiberationSerif-Italic.ttf}]{LiberationSerif-Regular.ttf}

 \newcommand{\codesample}[1]{
	\LTR
	\begin{latin}
		\lstinputlisting{#1}
	\end{latin}
	\RTL
}
\newcommand{\smalltitle}[1] {
	\noindent \textbf{#1}
}
\newcommand{\codebox}[1]{
	\begin{tcolorbox}[breakable,boxrule=0pt]
    \begin{latin}
        #1
    \end{latin}
    \end{tcolorbox}
	\vspace{0.2cm}
	\noindent
}

\newtcolorbox{mybox}[2][]{colback=red!5!white,
colframe=red!75!black,fonttitle=\bfseries,
colbacktitle=red!85!black,enhanced,
attach boxed title to top center={yshift=-2mm},
title=#2,#1}

\newenvironment{changemargin}[2]{%
\begin{list}{}{%
\setlength{\topsep}{0pt}%
\setlength{\leftmargin}{#1}%
\setlength{\rightmargin}{#2}%
\setlength{\listparindent}{\parindent}%
\setlength{\itemindent}{\parindent}%
\setlength{\parsep}{\parskip}%
}%
\item[]}{\end{list}}


\definecolor{foldercolor}{RGB}{124,166,198}
\definecolor{sectionColor}{HTML}{ff5e0e}
\definecolor{subsectionColor}{HTML}{008575}

\definecolor{listColor}{HTML}{00d3b9}

\definecolor{umlrelcolor}{HTML}{3c78d8}

\definecolor{subsubsectionColor}{HTML}{3c78d8}

\defpersianfont\authorFont[Scale=0.9,Path=fonts/]{XB Zar bold.ttf}

\defpersianfont\titr[Scale=1.5,Path=fonts/]{IRNazaninIrani.ttf}

\defpersianfont\fehrest[Scale=1.2,Path=fonts/]{IRNazaninIrani.ttf}

\defpersianfont\fehrestTitle[Scale=3.0,Path=fonts/]{IRNazaninIrani.ttf}

\defpersianfont\fehrestContent[Scale=1.2,Path=fonts/]{XB Zar bold.ttf}


\sectionfont{\color{sectionColor}}  % sets colour of sections
\subsectionfont{\color{subsectionColor}}  % sets colour of sections
\subsubsectionfont{\color{subsubsectionColor}}


\renewcommand{\labelitemii}{$\circ$}


\renewcommand{\baselinestretch}{1.1}


\renewcommand{\contentsname}{فهرست}

\renewcommand{\cfttoctitlefont}{\fehrestTitle}


\renewcommand\cftsecfont{\color{sectionColor}\fehrestContent\selectfont}
\renewcommand\cftsubsecfont{\color{subsectionColor}\fehrestContent\selectfont}
\renewcommand\cftsubsubsecfont{\color{subsubsectionColor}\fehrestContent\selectfont}
\renewcommand{\cftsecpagefont}{\color{sectionColor}}

\setlength{\parskip}{1.2pt}



%------------intro---------------
\newcommand{\heading}[0]{
	\textbf{ \Huge{به نام خدا} }
	
	\vspace{0.2cm}
	
	\includegraphics[width=0.4\textwidth]{source/sharif.png}\\
	\vspace{0.2cm}
	\textbf{ \Huge{\emph درس سیستم‌عامل پیشرفته} }\\
	\vspace{0.25cm}
	\textbf{ \Large{پروژه درس} }
	\vspace{0.2cm}
	
	
	\large \textbf{دانشکده مهندسی کامپیوتر}\\\vspace{0.1cm}
	\large   دانشگاه صنعتی شریف\\\vspace{0.2cm}
	\large   ﻧﯿﻢ سال دوم 02-01 \\\vspace{0.10cm}
	\noindent\rule[1ex]{\linewidth}{1pt}
	استاد:\\
	\textbf{{دکتر حسین اسدی}}
	
	\vspace{0.20cm}
	
	\vspace{0.10cm}
	مسئول فاز:\\
	\textbf{\authorFont{علی فرهانی}}
	
	\vspace{0.10cm}
	نویسندگان:\\
	\textbf{محمد هومان کشوری\\هیربد بهنام}
}



\newcommand{\pageheader}[0]{
%%% header of pages
	\pagestyle{fancy}
	\fancyhf{}
	\fancyfoot{}
	\cfoot{\thepage}
	\lhead{پروژه درس}
	\rhead{%\includegraphics[width=0.1\textwidth]{source/sharif.png}\\
		دانشکده مهندسی کامپیوتر
	}
	\chead{سیستم‌عامل پیشرفته}
	%%% header of pages
	\renewcommand{\headrulewidth}{2pt}
	
}

% https://tex.stackexchange.com/a/232188
\newcommand{\startunderscoreletter}{\catcode`_ 12\relax}
\newcommand{\stopunderscoreletter}{\catcode`_ 8\relax}

\newcommand{\readevents}[1]{
	\startunderscoreletter
	\begin{latin}
	\centering
	\begin{table}[H]
	\centering
	\begin{tabular}{c|c}
		\bfseries Event & \bfseries Occurrence
		\csvreader[head to column names]{#1}{}
		{\\\hline
		\csvcoli &
		\ifthenelse{\equal{\csvcolii}{0}}{NOT SUPPORTED}{\num{\csvcolii}}
		}
	\end{tabular}
	\caption{Event counters}
	\end{table}
	\end{latin}
	\stopunderscoreletter
}

% https://stackoverflow.com/a/68875792
\definecolorseries{piechartcolors}{rgb}{step}[rgb]{.95,.85,.55}{.17,.47,.37}
\resetcolorseries{piechartcolors}
\newcommand{\slice}[4]{
	\pgfmathsetmacro{\midangle}{0.5*#1+0.5*#2}
	\begin{scope}
		\clip (0,0) -- (#1:1) arc (#1:#2:1) -- cycle;
		\colorlet{SliceColor}{piechartcolors!!+}%
		\fill[inner color=SliceColor!30,outer color=SliceColor!60] (0,0) circle (1cm);
	\end{scope}
	\draw[thick] (0,0) -- (#1:1) arc (#1:#2:1) -- cycle;
	\node[label=\midangle:#4] at (\midangle:1) {};
	\pgfmathsetmacro{\temp}{min((#2-#1-10)/110*(-0.3),0)}
	\pgfmathsetmacro{\innerpos}{max(\temp,-0.5) + 0.8}
	\node at (\midangle:\innerpos) {#3};
}
\newcommand{\readreasonpie}[1] {
	\begin{latin}
	\centering
	\csvreader[before reading=\def\mysum{0}]{#1}{occurrence=\occurrence}{%
		\pgfmathsetmacro{\mysum}{\mysum+\occurrence}%
	}
	\begin{figure}[H]
	\centering
	\begin{tikzpicture}[scale=2]%
	\def\mya{0}\def\myb{0}
	\csvreader[head to column names]{#1}{}{%
		\let\mya\myb
		\pgfmathsetmacro{\myb}{\myb+\occurrence}
		\slice{\mya/\mysum*360}{\myb/\mysum*360}{\occurrence}{\reason}
	}
	\end{tikzpicture}
	\caption{TLB shootdown reasons}
	\end{figure}
	\end{latin}
}

\newcommand{\readreasonbar}[1]{
	\begin{latin}
	\begin{center}
	\begin{tikzpicture}
	\begin{axis}
	[
		ybar,
		enlargelimits=0.15,
		ylabel={\#Occurrence}, % the ylabel must precede a # symbol.
		xlabel={},
		symbolic x coords={flush on task switch (0), remote shootdown (1), local mm shootdown (3), remote ipi send (4)}, % these are the specification of coordinates on the x-axis.
		xtick=data,
		 nodes near coords, % this command is used to mention the y-axis points on the top of the particular bar.
		nodes near coords align={vertical},
		width=0.9\textwidth,
		height=0.5\textwidth,
		label style={font=\normalsize},
		tick label style={font=\small}
	]
	\addplot table [x=reason, y=occurrence, col sep=comma] {#1};
	\end{axis}
	\end{tikzpicture}
	\end{center}
	\end{latin}
}

\newcounter{stracerowcounter}
\newcommand{\readstrace}[1]{
	\startunderscoreletter
	\begin{latin}
	% Table for top usage
	\begin{table}[H]
	\centering
	\setcounter{stracerowcounter}{0}
	\begin{tabular}{c|c}
		\bfseries Syscall & \bfseries Usage
		\csvreader[head to column names]{#1}{}
		{% Hirbod: DO NOT FUCKING TOUCH THE %
			\stepcounter{stracerowcounter}%
			\ifnum\value{stracerowcounter}<10%
				\def\@tempa{\\\hline\csvcoli & \num{\csvcolii}}%
			\else%
				\def\@tempa{}%
			\fi%
			\@tempa%
		}
	\end{tabular}
	\qquad
	\begin{tabular}{c|c}
		\bfseries Desired Syscall & \bfseries Usage
		\csvreader[head to column names]{#1}{}
		{% Hirbod: DO NOT FUCKING TOUCH THE %
			\ifthenelse{\equal{\csvcoli}{mmap}}{%
				\def\@tempa{\\\hline\csvcoli & \num{\csvcolii}}%
			}{\def\@tempa{}}%
			\@tempa%
			\ifthenelse{\equal{\csvcoli}{munmap}}{%
				\def\@tempa{\\\hline\csvcoli & \num{\csvcolii}}%
			}{\def\@tempa{}}%
			\@tempa%
			\ifthenelse{\equal{\csvcoli}{msync}}{%
				\def\@tempa{\\\hline\csvcoli & \num{\csvcolii}}%
			}{\def\@tempa{}}%
			\@tempa%
			\ifthenelse{\equal{\csvcoli}{madvice}}{%
				\def\@tempa{\\\hline\csvcoli & \num{\csvcolii}}%
			}{\def\@tempa{}}%
			\@tempa%
			\ifthenelse{\equal{\csvcoli}{mprotect}}{%
				\def\@tempa{\\\hline\csvcoli & \num{\csvcolii}}%
			}{\def\@tempa{}}%
			\@tempa%
			\ifthenelse{\equal{\csvcoli}{mincore}}{%
				\def\@tempa{\\\hline\csvcoli & \num{\csvcolii}}%
			}{\def\@tempa{}}%
			\@tempa%
			\ifthenelse{\equal{\csvcoli}{malloc_mmap}}{%
				\def\@tempa{\\\hline\csvcoli & \num{\csvcolii}}%
			}{\def\@tempa{}}%
			\@tempa%
		}
	\end{tabular}
	\caption{Top and desired syscalls}
	\end{table}
	\end{latin}
	\stopunderscoreletter
}